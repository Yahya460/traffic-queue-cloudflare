<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>شاشة العرض</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#64748b;
      --line:rgba(2,6,23,.12);
      --shadow:0 12px 30px rgba(2,6,23,.08);
      --radius:18px;
      --male:#0ea5e9;   /* سماوي */
      --female:#a78bfa; /* بنفسجي لطيف */
      --center:#38bdf8; /* سماوي أغمق شوي */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1300px;margin:0 auto;padding:16px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin-bottom:12px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:62px;height:62px;border-radius:18px;background:#fff;border:1px solid var(--line);padding:8px;object-fit:contain}
    .t1{font-weight:900;font-size:20px}
    .t2{color:var(--muted);font-size:13px;margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;background:#fff;border:1px solid var(--line);
      box-shadow:var(--shadow);color:var(--muted);font-size:13px
    }
    .grid{
      display:grid;gap:12px;
      grid-template-columns:1fr 1.2fr 1fr;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .col{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .col .head{
      padding:12px 14px;font-weight:900;display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .head small{font-weight:600;color:var(--muted)}
    .col.male .head{background:rgba(14,165,233,.10)}
    .col.center .head{background:rgba(56,189,248,.14)}
    .col.female .head{background:rgba(167,139,250,.12)}
    .list{padding:10px 10px 12px 10px}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;margin:8px 0;border:1px solid var(--line);border-radius:16px;background:#fff;
    }
    .num{font-size:22px;font-weight:1000;letter-spacing:.5px}
    .meta{color:var(--muted);font-size:12px;line-height:1.2;text-align:left}
    .by{font-weight:800;color:#334155}
    .time{font-variant-numeric:tabular-nums}
    .empty{padding:14px;color:var(--muted);text-align:center}
    .footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
    .centerImageBox{
      margin:12px;
      border:1px dashed rgba(2,6,23,.25);
      border-radius:16px;
      background:rgba(2,6,23,.02);
      padding:10px;
    }
    .centerImageBox h3{margin:0 0 8px 0;font-size:13px;color:var(--muted)}
    .centerImageBox img{max-width:100%;border-radius:12px;border:1px solid var(--line);background:#fff}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img class="logo" src="/logo.png" alt="شعار معهد السلامة المرورية">
        <div>
          <div class="t1">شاشة العرض – معلمي السياقة</div>
          <div class="t2">معهد السلامة المرورية – صحار</div>
        </div>
      </div>
      <div class="pill" id="status">جاهز</div>
    </div>

    <div class="grid">
      <!-- رجال -->
      <div class="col male">
        <div class="head">
          <span>تم النداء – رجال</span>
          <small id="maleCount">0</small>
        </div>
        <div class="list" id="maleList"></div>
      </div>

      <!-- الوسط (كل النداءات + صورة العمود الأوسط إن وُجدت) -->
      <div class="col center">
        <div class="head">
          <span>جميع النداءات</span>
          <small id="allCount">0</small>
        </div>

        <div class="centerImageBox" id="centerImageBox" style="display:none">
          <h3>صورة من المدير</h3>
          <img id="centerImage" alt="Center Image">
        </div>

        <div class="list" id="allList"></div>
      </div>

      <!-- نساء -->
      <div class="col female">
        <div class="head">
          <span>تم النداء – نساء</span>
          <small id="femaleCount">0</small>
        </div>
        <div class="list" id="femaleList"></div>
      </div>
    </div>

    <div class="footer">جميع الحقوق محفوظة للرقيب أول يحيى آل عبدالسلام</div>
  </div>

<script>
  // ✅ نغمة بدون ملفات (فرق بين الرجال/النساء)
  function beep(type){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      // رجال = نغمة أعمق / نساء = أعلى
      o.frequency.value = (type === "female") ? 900 : 600;
      g.gain.value = 0.07;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 220);
    }catch(e){}
  }

  const statusEl = document.getElementById("status");
  const maleList = document.getElementById("maleList");
  const femaleList = document.getElementById("femaleList");
  const allList = document.getElementById("allList");
  const maleCount = document.getElementById("maleCount");
  const femaleCount = document.getElementById("femaleCount");
  const allCount = document.getElementById("allCount");

  const centerImageBox = document.getElementById("centerImageBox");
  const centerImage = document.getElementById("centerImage");

  let lastKey = ""; // آخر نداء عشان نشغل النغمة مرة واحدة فقط

  function fmtTime(ts){
    if(!ts) return "";
    try{
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return ${hh}:${mm};
    }catch(e){ return ""; }
  }

  function makeRow(item){
    const num = item.number ?? item.num ?? item.n ?? "";
    const g = (item.gender ?? item.type ?? "").toLowerCase();
    const by = item.by ?? item.staff ?? item.caller ?? "";
    const at = item.at ?? item.time ?? item.ts ?? "";

    return `
      <div class="row">
        <div class="num">رقم ${String(num)}</div>
        <div class="meta">
          <div class="by">${by ? "بواسطة: " + by : ""}</div>
          <div class="time">${at ? "الوقت: " + fmtTime(at) : ""}</div>
        </div>
      </div>
    `;
  }

  // نحاول نقرأ الدولة بأي شكل (عشان اختلافات مشروعك)
  function extractCalls(state){
    // أشهر أسماء ممكنة من مشروعك
    const candidates = [
      state.calls, state.history, state.log, state.lastCalls, state.recent,
      state?.data?.calls, state?.data?.history
    ];
    for(const c of candidates){
      if(Array.isArray(c)) return c;
    }
    // أحياناً تكون داخل state.ok فقط
    return [];
  }

  async function tick(){
    try{
      statusEl.textContent = "جاري التحديث…";
      const r = await fetch("/api/state", { cache: "no-store" });
      const j = await r.json();

      // صورة العمود الأوسط (إن وُجدت من المدير)
      if(j.centerImage && j.centerImage.image){
        centerImageBox.style.display = "block";
        centerImage.src = j.centerImage.image;
      }else{
        centerImageBox.style.display = "none";
      }

      const calls = extractCalls(j);

      // لو ما فيه بيانات
      if(!calls.length){
        maleList.innerHTML = <div class="empty">لا يوجد نداءات حالياً</div>;
        femaleList.innerHTML = <div class="empty">لا يوجد نداءات حالياً</div>;
        allList.innerHTML = <div class="empty">Waiting…</div>;
        maleCount.textContent = "0";
        femaleCount.textContent = "0";
        allCount.textContent = "0";
        statusEl.textContent = "جاهز";
        return;
      }

      // نفترض الجديد أول (وإن كان بالعكس نرتّب)
      // إذا كان آخر عنصر عندك هو الأحدث، غيّر reverse هنا
      const list = calls.slice().reverse();

      const males = [];
      const females = [];
      const all = [];

      for(const it of list){
        const g = String(it.gender || "").toLowerCase();
        all.push(it);
        if(g === "female" || g === "f" || g === "نساء") females.push(it);
        else males.push(it);
      }

      // عرض
      maleList.innerHTML = males.length ? males.map(makeRow).join("") : <div class="empty">لا يوجد نداءات رجال</div>;
      femaleList.innerHTML = females.length ? females.map(makeRow).join("") : <div class="empty">لا يوجد نداءات نساء</div>;
      allList.innerHTML = all.map(makeRow).join("");

      maleCount.textContent = String(males.length);
      femaleCount.textContent = String(females.length);
      allCount.textContent = String(all.length);

      // تشغيل النغمة عند تغيّر آخر نداء
      const latest = all[0];
      const key = ${latest.number || ""}|${latest.gender || ""}|${latest.at || ""}|${latest.by || ""};
      if(key && key !== lastKey){
        lastKey = key;
        const g = String(latest.gender || "").toLowerCase();
        beep((g === "female" || g === "f") ? "female" : "male");
      }

      statusEl.textContent = "متصل ✅";
    }catch(e){
      statusEl.textContent = "غير متصل ❌";
    }
  }

  // تحديث كل 2 ثانية
  tick();
  setInterval(tick, 2000);
</script>
</body>
</html>
