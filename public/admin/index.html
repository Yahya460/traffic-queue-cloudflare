<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin</title>
  <link rel="stylesheet" href="/styles.css"/>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Admin</h2>
      <span class="pill" id="status">...</span>
    </div>

    <div class="card">
      <div class="grid">
        <div class="row">
          <a href="/display/">Open Display</a>
          <a href="/staff/">Staff</a>
          <button class="red" id="logoutBtn">Logout</button>
        </div>

        <hr/>

        <h3 style="margin:0">Add user</h3>
        <div class="grid grid2">
          <div>
            <small>Username</small>
            <input id="newUser" placeholder="khalid"/>
          </div>
          <div>
            <small>Password</small>
            <input id="newPass" placeholder="1234"/>
          </div>
        </div>
        <div class="row">
          <select id="newRole">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
          <button id="addBtn">Add</button>
          <button id="reloadBtn">Reload list</button>
        </div>

        <hr/>

        <h3 style="margin:0">Users</h3>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr><th>Username</th><th>Role</th><th>Actions</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <hr/>

        <h3 style="margin:0">Ticker (bottom line)</h3>
        <div class="row">
          <input id="ticker" placeholder="Write message for display"/>
          <button id="tickerBtn">Send</button>
        </div>

        <h3 style="margin:0">Center image (upload/camera)</h3>
        <div class="row">
          <input id="imgFile" type="file" accept="image/*" capture="environment"/>
          <button id="sendImgBtn">Show on display</button>
          <button class="red" id="clearImgBtn">Clear</button>
        </div>
        <small>On phone: tap file â†’ choose Camera to take a photo.</small>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    const statusEl = App.$("#status");
    const tbody = App.$("#tbody");

    function requireAdmin(){
      const u = App.getUser();
      if(!u) return location.href="/login/";
      if(u.role !== "admin") return location.href="/staff/";
      App.setStatus(statusEl, u.username + " (admin)", "ok");
    }
    requireAdmin();

    function rowHtml(u){
      const promoteLabel = (u.role === "admin") ? "Make Staff" : "Promote to Admin";
      const promoteRole  = (u.role === "admin") ? "staff" : "admin";
      return `
        <tr>
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td class="actions">
            <button data-act="promote" data-user="${u.username}" data-role="${promoteRole}">${promoteLabel}</button>
            <button data-act="reset" data-user="${u.username}">Reset Pass</button>
            <button class="red" data-act="del" data-user="${u.username}">Delete</button>
          </td>
        </tr>`;
    }

    async function loadUsers(){
      const r = await App.API.usersList();
      if(!r.ok) return alert(r.error || "Cannot load users");
      tbody.innerHTML = (r.users || []).map(rowHtml).join("");
    }

    tbody.addEventListener("click", async (ev)=>{
      const btn = ev.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const user = btn.dataset.user;

      if(act === "del"){
        if(!confirm("Delete " + user + "?")) return;
        const r = await App.API.usersDelete(user);
        if(!r.ok) return alert(r.error || "Failed");
        return loadUsers();
      }

      if(act === "reset"){
        const pw = prompt("New password for " + user + ":");
        if(!pw) return;
        const r = await App.API.usersResetPassword(user, pw);
        if(!r.ok) return alert(r.error || "Failed");
        return alert("Password updated");
      }

      if(act === "promote"){
        const role = btn.dataset.role;
        const r = await App.API.usersSetRole(user, role);
        if(!r.ok) return alert(r.error || "Failed");
        return loadUsers();
      }
    });

    App.$("#addBtn").addEventListener("click", async ()=>{
      const u = App.$("#newUser").value.trim();
      const p = App.$("#newPass").value;
      const role = App.$("#newRole").value;
      const r = await App.API.usersAdd(u, p, role);
      if(!r.ok) return alert(r.error || "Failed");
      App.$("#newUser").value = "";
      App.$("#newPass").value = "";
      await loadUsers();
    });

    App.$("#reloadBtn").addEventListener("click", loadUsers);

    App.$("#logoutBtn").addEventListener("click", async ()=>{
      await App.API.logout();
      location.href="/login/";
    });

    App.$("#tickerBtn").addEventListener("click", async ()=>{
      const text = App.$("#ticker").value;
      const r = await App.API.setTicker(text);
      if(!r.ok) return alert(r.error || "Failed");
      alert("Sent");
    });

    let lastDataUrl = "";
    App.$("#sendImgBtn").addEventListener("click", async ()=>{
      const f = App.$("#imgFile").files?.[0];
      if(!f) return alert("Choose image/camera first");
      const dataUrl = await new Promise((res)=>{
        const rd = new FileReader();
        rd.onload = ()=>res(rd.result);
        rd.readAsDataURL(f);
      });
      lastDataUrl = dataUrl;
      const r = await App.API.setCenterImage(dataUrl);
      if(!r.ok) return alert(r.error || "Failed");
      alert("Shown on display");
    });

    App.$("#clearImgBtn").addEventListener("click", async ()=>{
      const r = await App.API.setCenterImage("");
      if(!r.ok) return alert(r.error || "Failed");
      alert("Cleared");
    });

    loadUsers();
  </script>
</body>
</html>