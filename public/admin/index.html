<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin</title>
  <link rel="stylesheet" href="/styles.css"/>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Admin</h2>
      <span class="pill" id="status">...</span>
    </div>

    <div class="card">
      <div class="grid">
        <div class="row">
          <a href="/display/">Open Display</a>
          <a href="/staff/">Staff</a>
          <button class="red" id="logoutBtn">Logout</button>
        </div>

        <hr/>

        <h3 style="margin:0">Add user</h3>
        <div class="grid grid2">
          <div>
            <small>Username</small>
            <input id="newUser" placeholder="khalid"/>
          </div>
          <div>
            <small>Password</small>
            <input id="newPass" placeholder="1234"/>
          </div>
        </div>
        <div class="row">
          <select id="newRole">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
          <button id="addBtn">Add</button>
          <button id="reloadBtn">Reload list</button>
        </div>

        <hr/>

        <h3 style="margin:0">Users</h3>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr><th>Username</th><th>Role</th><th>Actions</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <hr/>

        <h3 style="margin:0">Ticker (bottom line)</h3>
        <div class="row">
          <input id="ticker" placeholder="Write message for display"/>
          <button id="tickerBtn">Send</button>
        </div>

        <h3 style="margin:0">Center image (upload/camera)</h3>
        <div class="row">
          <input id="imgFile" type="file" accept="image/*" capture="environment"/>
          <button id="sendImgBtn">Show on display</button>
          <button class="red" id="clearImgBtn">Clear</button>
        </div>
        <small>On phone: tap file â†’ choose Camera to take a photo.</small>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    const statusEl = App.$("#status");
    const tbody = App.$("#tbody");

    function requireAdmin(){
      const u = App.getUser();
      if(!u) return location.href="/login/";
      if(u.role !== "admin") return location.href="/staff/";
      App.setStatus(statusEl, u.username + " (admin)", "ok");
    }
    requireAdmin();

    function rowHtml(u){
      const promoteLabel = (u.role === "admin") ? "Make Staff" : "Promote to Admin";
      const promoteRole  = (u.role === "admin") ? "staff" : "admin";
      return `
        <tr>
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td class="actions">
            <button data-act="promote" data-user="${u.username}" data-role="${promoteRole}">${promoteLabel}</button>
            <button data-act="reset" data-user="${u.username}">Reset Pass</button>
            <button class="red" data-act="del" data-user="${u.username}">Delete</button>
          </td>
        </tr>`;
    }

    async function loadUsers(){
      const r = await App.API.usersList();
      if(!r.ok) return alert(r.error || "Cannot load users");
      tbody.innerHTML = (r.users || []).map(rowHtml).join("");
    }

    tbody.addEventListener("click", async (ev)=>{
      const btn = ev.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const user = btn.dataset.user;

      if(act === "del"){
        if(!confirm("Delete " + user + "?")) return;
        const r = await App.API.usersDelete(user);
        if(!r.ok) return alert(r.error || "Failed");
        return loadUsers();
      }

      if(act === "reset"){
        const pw = prompt("New password for " + user + ":");
        if(!pw) return;
        const r = await App.API.usersResetPassword(user, pw);
        if(!r.ok) return alert(r.error || "Failed");
        return alert("Password updated");
      }

      if(act === "promote"){
        const role = btn.dataset.role;
        const r = await App.API.usersSetRole(user, role);
        if(!r.ok) return alert(r.error || "Failed");
        return loadUsers();
      }
    });

    App.$("#addBtn").addEventListener("click", async ()=>{
      const u = App.$("#newUser").value.trim();
      const p = App.$("#newPass").value;
      const role = App.$("#newRole").value;
      const r = await App.API.usersAdd(u, p, role);
      if(!r.ok) return alert(r.error || "Failed");
      App.$("#newUser").value = "";
      App.$("#newPass").value = "";
      await loadUsers();
    });

    App.$("#reloadBtn").addEventListener("click", loadUsers);

    App.$("#logoutBtn").addEventListener("click", async ()=>{
      await App.API.logout();
      location.href="/login/";
    });

    App.$("#tickerBtn").addEventListener("click", async ()=>{
      const text = App.$("#ticker").value;
      const r = await App.API.setTicker(text);
      if(!r.ok) return alert(r.error || "Failed");
      alert("Sent");
    });

    let lastDataUrl = "";
    App.$("#sendImgBtn").addEventListener("click", async ()=>{
      const f = App.$("#imgFile").files?.[0];
      if(!f) return alert("Choose image/camera first");
      const dataUrl = await new Promise((res)=>{
        const rd = new FileReader();
        rd.onload = ()=>res(rd.result);
        rd.readAsDataURL(f);
      });
      lastDataUrl = dataUrl;
      const r = await App.API.setCenterImage(dataUrl);
      if(!r.ok) return alert(r.error || "Failed");
      alert("Shown on display");
    });

    App.$("#clearImgBtn").addEventListener("click", async ()=>{
      const r = await App.API.setCenterImage("");
      if(!r.ok) return alert(r.error || "Failed");
      alert("Cleared");
    });

    loadUsers();
  </script>
</body>
</html><hr>
<h3>ğŸ“· ØµÙˆØ±Ø© ØªÙØ¹Ø±Ø¶ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ (ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)</h3>

<input id="imgFile" type="file" accept="image/*">
<button id="btnSendImg">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©</button>
<button id="btnClearImg">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©</button>

<br><br>

<button id="btnCam">ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
<button id="btnSnap" disabled>Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ¥Ø±Ø³Ø§Ù„</button>

<br><br>
<video id="cam" autoplay playsinline style="width:260px; border:1px solid #ccc; border-radius:12px; display:none;"></video>
<canvas id="cv" style="display:none;"></canvas>

<script>
  const imgFile = document.getElementById("imgFile");
  const btnSendImg = document.getElementById("btnSendImg");
  const btnClearImg = document.getElementById("btnClearImg");
  const btnCam = document.getElementById("btnCam");
  const btnSnap = document.getElementById("btnSnap");
  const cam = document.getElementById("cam");
  const cv = document.getElementById("cv");

  let stream = null;

  function fileToDataUrl(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  btnSendImg.onclick = async () => {
    if(!imgFile.files[0]) return alert("Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
    const dataUrl = await fileToDataUrl(imgFile.files[0]);
    const r = await App.API.setDisplayImage(dataUrl);
    if(!r.ok) return alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (r.error || r._status));
    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ âœ…");
  };

  btnClearImg.onclick = async () => {
    const r = await App.API.clearDisplayImage();
    if(!r.ok) return alert("ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: " + (r.error || r._status));
    alert("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© âœ…");
  };

  btnCam.onclick = async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      cam.srcObject = stream;
      cam.style.display = "block";
      btnSnap.disabled = false;
    }catch(e){
      alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + e.message);
    }
  };

  btnSnap.onclick = async () => {
    if(!stream) return;
    const w = cam.videoWidth || 640;
    const h = cam.videoHeight || 480;
    cv.width = w; cv.height = h;
    const ctx = cv.getContext("2d");
    ctx.drawImage(cam, 0, 0, w, h);
    const dataUrl = cv.toDataURL("image/jpeg", 0.85);

    const r = await App.API.setDisplayImage(dataUrl);
    if(!r.ok) return alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (r.error || r._status));
    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© âœ…");
Â Â };
</script>
