<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<script>
/* âœ… Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±: ÙŠØ¹ØªÙ…Ø¯ ÙÙ‚Ø· Ø¹Ù„Ù‰ role=admin */
(function () {
  const role = localStorage.getItem("role");
  const name = localStorage.getItem("username") || localStorage.getItem("name") || "";

  // Ø¥Ø°Ø§ Ù„ÙŠØ³ admin ÙŠØ±Ø¬Ø¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  if (role !== "admin") {
    location.replace("/login/");
    return;
  }

  // ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø§Ø³Ù… ÙÙŠ username
  if (name) localStorage.setItem("username", name);
})();
</script>

<div class="container">
  <div class="card">

    <div class="row" style="justify-content:space-between;align-items:center;gap:12px;">
      <div>
        <div class="h1">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</div>
        <div class="small" id="who"></div>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;">
        <a class="btn" href="/login/">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</a>
        <a class="btn" href="/staff/">ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ÙØ§Ø­Øµ</a>
        <a class="btn" href="/display/" target="_blank">ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶</a>
      </div>
    </div>

    <hr>

    <div class="row" style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <div class="small">
        âœ… Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©: â€œØ±ÙØ¹/ØªØµÙˆÙŠØ± ØµÙˆØ±Ø© Ù„Ù„Ø´Ø§Ø´Ø©â€ Ù„Ù† ÙŠØ¹Ù…Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† API ÙŠØ±Ø¬Ø¹ <b>NOT_FOUND</b> Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©.<br>
        Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ«Ø¨Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø£Ø¶Ù API Ù„Ù„ØµÙˆØ±Ø© ÙˆØªØ´ØªØºÙ„ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.
      </div>

      <div class="row" style="gap:10px;align-items:center;">
        <span class="badge" id="apiState">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
        <button class="btn" id="checkApiBtn">ØªØ£ÙƒØ¯ Ù…Ù† API</button>
      </div>
    </div>

    <hr>

    <h3 style="margin:10px 0;">ğŸ“· Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ø´Ø§Ø´Ø©</h3>
    <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;">
      <input type="file" id="fileInput" accept="image/*" capture="camera">
      <button class="btn" id="uploadBtn">Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</button>
      <span class="small" id="uploadStatus"></span>
    </div>

    <div style="margin-top:12px;">
      <img id="previewImg" alt="preview" style="max-width:100%;border-radius:12px;display:none;">
    </div>

    <hr>

    <div class="footer">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„ ÙŠØ­ÙŠÙ‰ Ø¢Ù„ Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù…</div>
  </div>
</div>

<script>
  // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø¯ÙˆØ±
  (function(){
    const role = localStorage.getItem("role") || "â€”";
    const name = localStorage.getItem("username") || localStorage.getItem("name") || "â€”";
    document.getElementById("who").textContent = Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${name} | Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${role};
  })();

  // API Health
  const apiState = document.getElementById("apiState");
  const checkApiBtn = document.getElementById("checkApiBtn");

  async function checkAPI(){
    apiState.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµ...";
    try{
      const r = await fetch("/api/health", { cache: "no-store" });
      const j = await r.json();
      if (j && j.ok) {
        apiState.textContent = "Ø¬Ø§Ù‡Ø²";
      } else {
        apiState.textContent = "ØºÙŠØ± Ø¬Ø§Ù‡Ø²";
      }
    }catch(e){
      apiState.textContent = "ØºÙŠØ± Ø¬Ø§Ù‡Ø²";
    }
  }
  checkApiBtn.addEventListener("click", checkAPI);
  checkAPI();

  // Upload
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const uploadStatus = document.getElementById("uploadStatus");
  const previewImg = document.getElementById("previewImg");

  uploadBtn.onclick = async () => {
    if (!fileInput.files.length) {
      uploadStatus.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹";
      return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    uploadStatus.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹...";
    try{
      const res = await fetch("/api/upload", { method: "POST", body: formData });
      const data = await res.json();

      if (data.ok) {
        uploadStatus.textContent = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­";
        if (data.preview) {
          previewImg.src = data.preview;
          previewImg.style.display = "block";
        }
      } else {
        uploadStatus.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + (data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
      }
    }catch(e){
      uploadStatus.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";
    }
  };

  // Ø¬Ù„Ø¨ Ø¢Ø®Ø± ØµÙˆØ±Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
  (async function(){
    try{
      const r = await fetch("/api/last-image", { cache: "no-store" });
      const j = await r.json();
      if (j && j.ok && j.image && j.image.preview) {
        previewImg.src = j.image.preview;
        previewImg.style.display = "block";
      }
    }catch(e){}
  })();
</script>

</body>
</html>
