<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <img src="/logo.png" alt="logo" style="width:52px;height:52px;border-radius:14px;border:1px solid rgba(15,23,42,.15);padding:6px;object-fit:contain" onerror="this.style.display='none'">
        <div>
          <div class="h1">تسجيل الدخول</div>
          <div class="small">خاص بالمدير / الفاحص</div>
        </div>
      </div>
      <span class="pill" id="st">جاهز</span>
    </div>

    <hr>

    <div class="grid grid2">
      <div>
        <div class="small">اسم المستخدم</div>
        <input id="u" autocomplete="username" placeholder="مثال: يوسف">
      </div>
      <div>
        <div class="small">كلمة المرور</div>
        <input id="p" type="password" autocomplete="current-password" placeholder="••••••">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="btn">دخول</button>
      <span class="badge" id="hint"></span>
    </div>

    <hr>

    <div class="small box">
      روابط الصفحات:
      <div class="row" style="margin-top:8px">
        <a class="pill" href="/display/">شاشة العرض</a>
        <a class="pill" href="/staff/">شاشة الفاحص</a>
        <a class="pill" href="/admin/">لوحة المدير</a>
      </div>
    </div>

    <div class="footer">جميع الحقوق محفوظة للرقيب أول يحيى آل عبدالسلام</div>
  </div>
</div>

<script src="/app.js"></script>
<script>
  const st = document.getElementById("st");
  const u  = document.getElementById("u");
  const p  = document.getElementById("p");
  const btn= document.getElementById("btn");
  const hint= document.getElementById("hint");

  // فحص API سريع
  App.API.health().then(r=>{
    App.setStatus(st, r && r.ok ? "API متصل ✅" : "API غير متصل", r && r.ok);
  }).catch(()=> App.setStatus(st, "API غير متصل", false));

  async function go(){
    try{
      App.setStatus(st, "جاري الدخول...", null);
      btn.disabled = true;
      const r = await App.API.login(u.value.trim(), p.value);
      App.setToken(r.token || "");
      App.setMe(r.username, r.role);
      App.setStatus(st, "تم الدخول ✅", true);

      if (r.role === "admin") location.href = "/admin/";
      else location.href = "/staff/";
    }catch(e){
      App.setStatus(st, "فشل تسجيل الدخول", false);
      hint.textContent = (e && e.message) ? e.message : "";
    }finally{
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", go);
  p.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") go(); });
</script>
</body>
</html>
