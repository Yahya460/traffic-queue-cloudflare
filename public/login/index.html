<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>تسجيل الدخول</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="h1">خاص بتسجيل دخول الفاحص / المدير</div>

      <div class="grid">
        <label class="small">اسم المستخدم</label>
        <input id="u" placeholder="يوسف" autocomplete="username">

        <label class="small">كلمة المرور</label>
        <input id="p" type="password" placeholder="2626" autocomplete="current-password">

        <button id="btn" class="btn">دخول</button>

        <div class="small" id="status">جاهز</div>
      </div>

      <div class="footer">جميع الحقوق محفوظة للرقيب أول يحيى آل عبدالسلام</div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    const u = document.getElementById("u");
    const p = document.getElementById("p");
    const btn = document.getElementById("btn");
    const statusEl = document.getElementById("status");

    async function doLogin(){
      try{
        App.setStatus(statusEl, "جاري تسجيل الدخول...", null);

        const r = await App.API.login(u.value.trim(), p.value.trim());

        if(!r.ok){
          App.setStatus(statusEl, "فشل تسجيل الدخول", false);
          return;
        }

        // ✅ هذا الشكل مطابق للـ Worker عندك:
        // { ok:true, role:"admin", name:"يوسف" }
        App.setMe(r.name || "", r.role || "");

        App.setStatus(statusEl, "تم تسجيل الدخول بنجاح ✅", true);

        // ✅ التحويل حسب الصلاحية
        if ((r.role || "").toLowerCase() === "admin") {
          location.href = "/admin/";
        } else {
          location.href = "/staff/";
        }

      }catch(e){
        App.setStatus(statusEl, "فشل: تأكد من API", false);
        console.log(e);
      }
    }

    btn.addEventListener("click", doLogin);
    p.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") doLogin(); });
  </script>
</body>
</html>
