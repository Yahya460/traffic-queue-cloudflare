<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>تسجيل الدخول</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div>
          <div class="h1">تسجيل الدخول</div>
          <div class="small">خاص بالمدير / الفاحص</div>
        </div>
      </div>

      <div class="row gap" style="margin-top:12px;">
        <div style="flex:1">
          <label class="small">اسم المستخدم</label>
          <input id="u" type="text" placeholder="مثال: يوسف" autocomplete="username">
        </div>
        <div style="flex:1">
          <label class="small">كلمة المرور</label>
          <input id="p" type="password" placeholder="••••" autocomplete="current-password">
        </div>
      </div>

      <div class="row gap" style="margin-top:12px;align-items:center;">
        <button id="btn">دخول</button>
        <span id="st" class="small"></span>
      </div>

      <div class="small" style="margin-top:10px;opacity:.8">
        روابط الصفحات:
        <a href="/admin/">لوحة المدير</a> |
        <a href="/staff/">شاشة الفاحص</a> |
        <a href="/display/">شاشة العرض</a>
      </div>

      <div class="footer">جميع الحقوق محفوظة للرقيب أول يحيى آل عبدالسلام</div>
    </div>
  </div>

<script>
const u = document.getElementById("u");
const p = document.getElementById("p");
const btn = document.getElementById("btn");
const st = document.getElementById("st");

async function go(){
  st.textContent = "جاري الدخول...";
  btn.disabled = true;

  try{
    const res = await fetch("/api/login",{
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ username: u.value.trim(), password: p.value.trim() })
    });

    const data = await res.json();

    if(!data.ok){
      st.textContent = "فشل تسجيل الدخول";
      btn.disabled = false;
      return;
    }

    // ✅ أهم سطرين لحل مشكلة صلاحيات المدير
    localStorage.setItem("role", data.role || "");
    localStorage.setItem("username", data.name || data.username || u.value.trim());

    st.textContent = "تم تسجيل الدخول ✅";

    // توجيه حسب الصلاحية
    if((data.role || "") === "admin") location.href = "/admin/";
    else location.href = "/staff/";

  }catch(e){
    st.textContent = "خطأ اتصال";
    btn.disabled = false;
  }
}

btn.addEventListener("click", go);
p.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") go(); });
</script>

</body>
</html>
